<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚è³¼è¡¨å–®</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], select { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        .message { margin-top: 20px; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        /* LIFF è³‡è¨Šé¡¯ç¤ºæ¨£å¼ */
        #liff-info {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            background-color: #e9ecef;
        }
        #liff-info h2 {
            margin-top: 0;
            color: #333;
            font-size: 1.2em;
        }
        #liff-info p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        #liff-info img {
            vertical-align: middle;
            margin-right: 10px;
        }

        #myForm { display: none; } /* ğŸ”§ ä¿®æ­£é‡é» 2ï¼šè¡¨å–®é è¨­éš±è— */
        
    </style>
</head>
<body>
    <div class="container">
        <h1> </h1>

        <div id="liff-info">
            <h2>è¨‚è³¼äººLINEè³‡è¨Š</h2>
            <p><strong>é ­åƒ:</strong> <span id="liff-pictureUrl-container">è¼‰å…¥ä¸­...</span></p>
            <p><strong>é¡¯ç¤ºåç¨±:</strong> <span id="liff-displayName">è¼‰å…¥ä¸­...</span></p>
        </div>

        <div id="friendship-alert">
            <p>è«‹å…ˆå°‡æœ¬å®˜æ–¹å¸³è™ŸåŠ ç‚ºå¥½å‹ï¼Œæ‰èƒ½ä½¿ç”¨æ­¤è¡¨å–®ã€‚</p>
            <button onclick="liff.openWindow({ url: 'https://line.me/R/ti/p/@498okygz'});">
                åŠ å…¥å¥½å‹
            </button>
        </div>
        
        <form id="myForm">
            <label for="textField1">é£²æ–™å“é …:</label>
            <input type="text" id="textField1" name="textField1" placeholder="é»‘ç³–çç é®®å¥¶èŒ¶" required>

            <label for="dropdown2">ç”œåº¦:</label>
            <select id="dropdown2" name="dropdown2" required>
                <option value="" selected disabled></option>
                <option value="æ­£å¸¸(ååˆ†)">æ­£å¸¸(ååˆ†)</option>
                <option value="å°‘ç³–(å…«åˆ†)">å°‘ç³–(å…«åˆ†)</option>
                <option value="åŠç³–(äº”åˆ†)">åŠç³–(äº”åˆ†)</option>
                <option value="å¾®ç³–(ä¸‰åˆ†)">å¾®ç³–(ä¸‰åˆ†)</option>
                <option value="ç„¡ç³–">ç„¡ç³–</option>
            </select>

            <label for="dropdown3">å†°å¡Š:</label>
            <select id="dropdown3" name="dropdown3" required>
                <option value="" selected disabled></option>
                <option value="æ­£å¸¸(ååˆ†)">æ­£å¸¸(ååˆ†)</option>
                <option value="å°‘å†°(å…«åˆ†)">å°‘å†°(å…«åˆ†)</option>
                <option value="å¾®å†°(ä¸‰åˆ†)">å¾®å†°(ä¸‰åˆ†)</option>
                <option value="å»å†°(è–„å†°)">å»å†°(è–„å†°)</option>
            </select>
            
            <label for="textField2">æ•¸é‡:</label>
            <input type="text" id="textField2" name="textField2" required>

            <label for="textField4">åˆ†æ©Ÿ:</label>
            <input type="text" id="textField4" name="textField4" placeholder="#123" required>
            
            <label for="textField3">å‚™è¨»:</label>
            <input type="text" id="textField3" name="textField3" placeholder="ä¾‹å¦‚ï¼šåŠ çç ã€è¢‹å­åˆ†è£ç­‰">
            
            <button type="submit">é€å‡ºè¡¨å–®</button>
        </form>
        <div id="message" class="message" style="display: none;"></div>
    </div>

    <script>
        // *** è«‹å°‡é€™è£¡æ›¿æ›æˆæ‚¨çš„ Google Apps Script ç¶²é æ‡‰ç”¨ç¨‹å¼ URL ***
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx-D40V411AtObPcOo20yaQjwtdCf9nooh05h-a6DLEaAvbwqQ3ku2xU_cTgHqjUvXy8w/exec"; 
        // ä¾‹å¦‚: 'https://script.google.com/macros/s/AKfycbxxxxxxxxx/exec'

        // *** è«‹å°‡é€™è£¡æ›¿æ›æˆæ‚¨çš„ n8n Webhook URL ***
        const N8N_WEBHOOK_URL = "https://projectboy-n8n-free.hf.space/webhook/form"; 
        // ä¾‹å¦‚: 'https://webhook.site/your-unique-id' æˆ– 'https://your.n8n.domain/webhook/your-path'

        // *** è«‹å°‡é€™è£¡æ›¿æ›æˆæ‚¨çš„ LIFF ID ***
        const LIFF_ID = "2007786741-nWNbGDkL"; 

        // å…¨å±€è®Šæ•¸ç”¨æ–¼å„²å­˜ LIFF ç”¨æˆ¶è³‡æ–™
        let liffUserData = null;
        let isFriend = false; // æ–°å¢è®Šæ•¸ä¾†è¿½è¹¤å¥½å‹ç‹€æ…‹

        document.addEventListener('DOMContentLoaded', () => {
            //fetchDropdownOptions('é¸é …æ¸…å–®', 'dropdown1'); // å¾ 'é¸é …æ¸…å–®' å·¥ä½œè¡¨å¡«å……ç¬¬ä¸€å€‹ä¸‹æ‹‰é¸å–®
            //fetchDropdownOptions('é¸é …æ¸…å–®2', 'dropdown2'); // å¾ 'é¸é …æ¸…å–®2' å·¥ä½œè¡¨å¡«å……ç¬¬äºŒå€‹ä¸‹æ‹‰é¸å–®
            //fetchDropdownOptions('é¸é …æ¸…å–®3', 'dropdown3'); // å¾ 'é¸é …æ¸…å–®3' å·¥ä½œè¡¨å¡«å……ç¬¬ä¸‰å€‹ä¸‹æ‹‰é¸å–®

            const myForm = document.getElementById('myForm');
            const messageDiv = document.getElementById('message');

            myForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // é˜²æ­¢è¡¨å–®é è¨­æäº¤è¡Œç‚º

                // å†æ¬¡æª¢æŸ¥å¥½å‹ç‹€æ…‹ï¼Œç¢ºä¿ä¸æœƒåœ¨éå¥½å‹ç‹€æ…‹ä¸‹é€å‡ºè¡¨å–®
                if (!isFriend) {
                    showMessage('è«‹å…ˆåŠ å…¥å¥½å‹æ‰èƒ½é€å‡ºè¡¨å–®ï¼', 'error');
                    return;
                }

                // --- 1. é€å‡ºè¡¨å–®å‰åˆ¤æ–·æ™‚é–“ ---
Â  Â  Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  Â  Â  const currentHour = now.getHours();
Â  Â  Â  Â  Â  Â  Â  Â  const currentMinute = now.getMinutes();

Â  Â  Â  Â  Â  Â  Â  Â  // å°‡ 10:30 AM è½‰æ›ç‚ºå°æ™‚å’Œåˆ†é˜
Â  Â  Â  Â  Â  Â  Â  Â  const cutoffHour = 10;
Â  Â  Â  Â  Â  Â  Â  Â  const cutoffMinute = 30;

Â  Â  Â  Â  Â  Â  Â  Â  if (currentHour > cutoffHour || (currentHour === cutoffHour && currentMinute > cutoffMinute)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage('å·²è¶…éè¨‚è³¼æ™‚é–“ (10:30 AM)ï¼Œç„¡æ³•é€å‡ºè¡¨å–®ã€‚', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; // é˜»æ­¢è¡¨å–®æäº¤
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // --- æ™‚é–“åˆ¤æ–·çµæŸ ---
                
                const formData = new FormData(myForm);
                const data = {};
                for (const [key, value] of formData.entries()) {
                    data[key] = value;
                }

                // --- æ–°å¢ï¼šåˆ¤æ–· textField3 æ¬„ä½æ˜¯å¦ç‚ºç©ºç™½ï¼Œå¦‚æœç©ºç™½å›å‚³"ç„¡" ---
                // æª¢æŸ¥ textField3 æ˜¯å¦ç‚ºç©ºå­—ä¸²ã€undefined æˆ– null
                if (data.textField3 === '' || data.textField3 === undefined || data.textField3 === null) {
                    data.textField3 = 'ç„¡'; // å°‡å…¶è¨­å®šç‚º "ç„¡"
                }
                // --- åˆ¤æ–·çµæŸ ---
                
                // å°‡ LIFF ç”¨æˆ¶è³‡æ–™åŠ å…¥åˆ°æäº¤çš„æ•¸æ“šä¸­
                if (liffUserData) {
                    data.liffUserId = liffUserData.userId;
                    data.liffDisplayName = liffUserData.displayName;
                    data.liffPictureUrl = liffUserData.pictureUrl;
                    data.liffStatusMessage = liffUserData.statusMessage;
                } else {
                    console.warn("LIFF ç”¨æˆ¶è³‡æ–™æœªè¼‰å…¥ï¼Œè¡¨å–®å°‡ä¸åŒ…å« LIFF è³‡è¨Šã€‚");
                    // ä½ å¯ä»¥åœ¨é€™è£¡æ±ºå®šæ˜¯å¦é˜»æ­¢è¡¨å–®æäº¤ï¼Œå¦‚æœ LIFF è³‡è¨Šæ˜¯å¿…è¦çš„
                    // showMessage('è«‹ç­‰å¾… LIFF è³‡è¨Šè¼‰å…¥å¾Œå†æäº¤è¡¨å–®ã€‚', 'error');
                    // return;
                }

                try {
                    const response = await fetch(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        showMessage('è¡¨å–®å·²æˆåŠŸé€å‡ºï¼', 'success');
                        myForm.reset(); // æ¸…ç©ºè¡¨å–®
                        // é‡æ–°è¼‰å…¥ä¸‹æ‹‰é¸å–®é¸é …ï¼Œä»¥é˜²è¬ä¸€
                        fetchDropdownOptions('é¸é …æ¸…å–®', 'dropdown1');
                        fetchDropdownOptions('é¸é …æ¸…å–®2', 'dropdown2');
                        fetchDropdownOptions('é¸é …æ¸…å–®3', 'dropdown3');

                        // --- 2. é€å‡ºè¡¨å–®å¾Œé—œé–‰ LIFF è¦–çª— ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (liff.isInClient()) { // åˆ¤æ–·æ˜¯å¦åœ¨ LINE æ‡‰ç”¨ç¨‹å¼å…§
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  liff.closeWindow(); // é—œé–‰ LIFF è¦–çª—
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 1000); // 2ç§’å¾Œé—œé–‰ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°æˆåŠŸè¨Šæ¯
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- é—œé–‰ LIFF è¦–çª—çµæŸ ---
                        
                    } else {
                        const errorText = await response.text();
                        showMessage(`é€å‡ºå¤±æ•—: ${response.status} - ${errorText}`, 'error');
                    }
                } catch (error) {
                    console.error('é€å‡ºéŒ¯èª¤:', error);
                    showMessage(`é€å‡ºéŒ¯èª¤: ${error.message}`, 'error');
                }
            });

            async function fetchDropdownOptions(sheetName, dropdownId) {
                const dropdown = document.getElementById(dropdownId);
                dropdown.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>'; // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                dropdown.disabled = true; // è¼‰å…¥æ™‚ç¦ç”¨

                try {
                    const response = await fetch(`${APPS_SCRIPT_URL}?sheetName=${sheetName}`);
                    const options = await response.json();

                    dropdown.innerHTML = '<option value="">è«‹é¸æ“‡</option>'; // é‡ç½®é¸é …
                    if (options.error) {
                        dropdown.innerHTML = `<option value="">éŒ¯èª¤: ${options.error}</option>`;
                        console.error(`è¼‰å…¥ ${sheetName} é¸é …å¤±æ•—: ${options.error}`);
                    } else {
                        options.forEach(option => {
                            const optionElement = document.createElement('option');
                            optionElement.value = option;
                            optionElement.textContent = option;
                            dropdown.appendChild(optionElement);
                        });
                    }
                } catch (error) {
                    dropdown.innerHTML = `<option value="">è¼‰å…¥å¤±æ•—</option>`;
                    console.error(`è¼‰å…¥ ${sheetName} é¸é …æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
                } finally {
                    dropdown.disabled = false; // è¼‰å…¥å®Œæˆå¾Œå•Ÿç”¨
                }
            }

            function showMessage(msg, type) {
                messageDiv.textContent = msg;
                messageDiv.className = `message ${type}`;
                messageDiv.style.display = 'block';
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000); // 5ç§’å¾Œéš±è—è¨Šæ¯
            }

            // --- LIFF åˆå§‹åŒ–å’Œç”¨æˆ¶è³‡æ–™ç²å– ---
            async function initializeLiff() {
                const friendshipAlert = document.getElementById('friendship-alert');
                try {
                    await liff.init({ liffId: LIFF_ID });

                    if (!liff.isLoggedIn()) {
                        // å¦‚æœæœªç™»å…¥ï¼Œå‰‡å°å‘ LIFF ç™»å…¥é é¢
                        // åœ¨çœŸå¯¦ç’°å¢ƒä¸­ï¼ŒLIFF é é¢é€šå¸¸é æœŸåœ¨ LINE App å…§é–‹å•Ÿ
                        // å¦‚æœåœ¨å¤–éƒ¨ç€è¦½å™¨æ‰“é–‹ï¼Œliff.login() æœƒå¼•å°åˆ° LINE ç™»å…¥
                        liff.login({ redirectUri: window.location.href });
                        return; // ç™»å…¥å¾Œé é¢æœƒé‡æ–°è¼‰å…¥ï¼Œæ‰€ä»¥åœ¨æ­¤è¿”å›
                    }

                    // å¦‚æœå·²ç™»å…¥ï¼Œç²å–ç”¨æˆ¶å€‹äººè³‡æ–™
                    const profile = await liff.getProfile();
                    liffUserData = profile; // å„²å­˜ç”¨æˆ¶è³‡æ–™åˆ°å…¨å±€è®Šæ•¸
                    console.log("LIFF Profile:", liffUserData); // åœ¨æ§åˆ¶å°æŸ¥çœ‹ç”¨æˆ¶è³‡æ–™

                    // å°‡ç”¨æˆ¶è³‡è¨Šé¡¯ç¤ºåœ¨ç¶²é ä¸Š
                    document.getElementById('liff-displayName').textContent = liffUserData.displayName;
                    
                    const pictureUrlContainer = document.getElementById('liff-pictureUrl-container');
                    pictureUrlContainer.innerHTML = ''; // æ¸…ç©ºåŸæœ‰å…§å®¹
                    if (liffUserData.pictureUrl) {
                        const img = document.createElement('img');
                        img.src = liffUserData.pictureUrl;
                        img.style.width = '50px';
                        img.style.height = '50px';
                        img.style.borderRadius = '50%';
                        img.alt = 'é ­åƒ';
                        pictureUrlContainer.appendChild(img);
                    } else {
                        pictureUrlContainer.textContent = 'ç„¡';
                    }
                    
                    // *** æ–°å¢å¥½å‹ç‹€æ…‹åˆ¤æ–·é‚è¼¯ (å¢åŠ é™¤éŒ¯è¼¸å‡º) ***
                    const friendship = await liff.getFriendship();
                    console.log("LIFF Friendship object:", friendship); // è¼¸å‡ºå®Œæ•´çš„ friendship ç‰©ä»¶
                    console.log("friendship.friendFlag:", friendship.friendFlag); // è¼¸å‡º friendFlag çš„å€¼

                    if (friendship.friendFlag) {
                        isFriend = true;
                        // å¦‚æœæ˜¯å¥½å‹ï¼Œé¡¯ç¤ºè¡¨å–®ï¼Œéš±è—æç¤ºè¨Šæ¯
                        friendshipAlert.style.display = 'none'; // éš±è—å¥½å‹æç¤º
                        myForm.style.display = 'block'; // é¡¯ç¤ºè¡¨å–®
                        console.log("ç”¨æˆ¶å·²æ˜¯å¥½å‹ã€‚è¡¨å–®å·²é¡¯ç¤ºï¼Œå¥½å‹æç¤ºå·²éš±è—ã€‚");
                    } else {
                        isFriend = false;
                        // å¦‚æœä¸æ˜¯å¥½å‹ï¼Œéš±è—è¡¨å–®ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
                        myForm.style.display = 'none'; // éš±è—è¡¨å–®
                        friendshipAlert.style.display = 'block'; // é¡¯ç¤ºå¥½å‹æç¤º
                        console.log("ç”¨æˆ¶ä¸æ˜¯å¥½å‹ã€‚è¡¨å–®å·²éš±è—ï¼Œå¥½å‹æç¤ºå·²é¡¯ç¤ºã€‚");
                    }
                    console.log("isFriend status after check:", isFriend); // è¼¸å‡º isFriend æœ€çµ‚ç‹€æ…‹

                } catch (err) {
                    console.error("LIFF åˆå§‹åŒ–æˆ–ç²å–è³‡æ–™å¤±æ•—:", err);
                    // åœ¨é€™è£¡æ›´æ–° UI é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œä¾‹å¦‚ï¼š
                    document.getElementById('liff-userId').textContent = 'è¼‰å…¥å¤±æ•—';
                    document.getElementById('liff-displayName').textContent = 'è¼‰å…¥å¤±æ•—';
                    document.getElementById('liff-pictureUrl-container').textContent = 'è¼‰å…¥å¤±æ•—';
                    document.getElementById('liff-statusMessage').textContent = 'è¼‰å…¥å¤±æ•—';
                    alert("LIFF è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ LIFF ID æˆ–ç¶²è·¯é€£ç·šã€‚");
                }
            }

            // ç•¶é é¢å…§å®¹å®Œå…¨è¼‰å…¥å¾ŒåŸ·è¡Œ LIFF åˆå§‹åŒ–
            window.addEventListener('load', initializeLiff);
        });
    </script>
</body>
</html>



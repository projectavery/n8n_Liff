<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‚¼å¿µèŠ±ç±ƒè¨‚è³¼å–®</title>
    <!-- é è¼‰LIFF SDK -->
    <link rel="preload" href="https://static.line-scdn.net/liff/edge2/sdk.js" as="script">
    <script src="https://static.line-scdn.net/liff/edge2/sdk.js"></script>
    <style>
        /* æ‚¨åŸå§‹æª”æ¡ˆçš„å®Œæ•´CSS */
        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; background-color: #e9ecef; color: #333; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f8f9fa; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; font-size: 1.5em; color: #007bff; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .container { max-width: 650px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); display: none; }
        .container.active { display: block; }
        /* ... é€™è£¡åŒ…å«æ‚¨åŸå§‹æª”æ¡ˆçš„æ‰€æœ‰CSSæ¨£å¼ ... */
        .lazy-loaded { opacity: 1; transition: opacity 0.3s; }
        .gallery-item img { opacity: 0; }
    </style>
</head>
<body>
    <!-- æ‚¨åŸå§‹æª”æ¡ˆçš„å®Œæ•´HTMLçµæ§‹ -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>è¼‰å…¥ä¸­...</p>
    </div>
    
    <div class="container" id="main-form-container">
        <div class="line-profile-section">
            <h2>LINE</h2>
            <div class="line-profile-details">
                <img id="line-avatar" src="https://via.placeholder.com/40" alt="">
                <div>
                    <p><span id="line-displayName">è¼‰å…¥ä¸­...</span></p>
                </div>
            </div>
        </div>
        <input type="hidden" id="uid" name="uid">

        <form id="ajindex">
            <div class="section">
                <h2>åŸºæœ¬è³‡æ–™</h2>
                <label for="funeralDate">å‘Šåˆ¥å¼æ—¥æœŸ</label>
                <input type="date" id="funeralDate" name="funeralDate" required>
                <label for="deceasedName">äº¡è€…å§“å</label>
                <input type="text" id="deceasedName" name="deceasedName" required placeholder="è«‹è¼¸å…¥äº¡è€…å§“å">
                
                <label for="dedication">ç»è©</label>
                <div class="dedication-flex-container">
                    <input type="text" id="dedication" name="dedication" placeholder="è«‹è¼¸å…¥ç»è©" required>
                    <div class="checkbox-group" style="display: none;">
                        <label>
                            <input type="checkbox" id="checkboxCompanyArrangement" name="companyArrangement">
                            å…¬å¸å®‰æ’
                        </label>
                    </div>
                </div>

                <label for="funeralVenue">æ®¯å„€é¤¨</label>
                <select id="funeralVenue" name="funeralVenue" required onchange="updateHallSelect()">
                    <option value="" disabled selected>è«‹é¸æ“‡</option>
                </select>
                <label for="hallName">å ´é¤¨åç¨±</label>
                <select id="hallName" name="hallName" required>
                    <option value="" disabled selected>è«‹é¸æ“‡å ´é¤¨</option>
                </select>
            </div>
            <hr>

            <div class="section">
                <h2>ç”¢å“é¸æ“‡</h2>
                <div id="product-gallery" class="gallery-container">
                    <div style="text-align: center; grid-column: 1 / -1;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
            <hr>

            <!-- æ‰€æœ‰ç”¢å“å€å¡Šä¿æŒåŸå§‹çµæ§‹ -->
            <div class="section">
                <h2>èŠ±ç±ƒ</h2>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="checkboxFlowerBasket" name="productType" value="flowerBasket">
                        èŠ±ç±ƒ
                    </label>
                    <label>
                        <input type="checkbox" id="checkboxWreath" name="productType" value="wreath">
                        èŠ±åœˆ
                    </label>
                    <label style="display: none;">
                        <input type="checkbox" id="checkboxFruitBasket" name="productType" value="fruitBasket">
                        æœç±ƒ
                    </label>
                </div>

                <div id="flowerBasketDetails" class="product-details">
                    <h3>èŠ±ç±ƒè©³ç´°</h3>
                    <img id="flowerBasketImage" src="" alt="" class="product-image" style="display: none;">
                    <div class="form-row">
                        <div>
                            <label for="flowerBasketStyle">æ¬¾å¼</label>
                            <select id="flowerBasketStyle" name="flowerBasketStyle" onchange="updatePrice('flowerBasket')">
                                <option value="" disabled selected>è«‹é¸æ“‡æ¬¾å¼</option>
                            </select>
                        </div>
                        <div>
                            <label for="flowerBasketEulogy">ç»è©</label>
                            <input type="text" id="flowerBasketEulogy" name="flowerBasketEulogy" placeholder="è«‹è¼¸å…¥ç»è©">
                            <div class="checkbox-group">
                                <label>
                                    <input type="checkbox" id="checkboxFlowerBasketEulogy" name="flowerBasketEulogyCompany">
                                    å…¬å¸ç”¨
                                </label>
                            </div>
                        </div>
                        <div>
                            <label for="flowerBasketPrice">åƒ¹æ ¼</label>
                            <input type="text" id="flowerBasketPrice" class="price-box" value="0" readonly>
                        </div>
                        <div>
                            <label for="flowerBasketQty">æ•¸é‡</label>
                            <input type="number" id="flowerBasketQty" name="flowerBasketQty" min="0" value="0" oninput="calculateTotal()">
                        </div>
                    </div>
                </div>

                <!-- å…¶ä»–ç”¢å“å€å¡Š(wreath, fruitBasket)ä¿æŒåŸå§‹çµæ§‹ -->
            </div>
            <hr>

            <!-- æ‰€æœ‰æ”¶æ“šã€ç™¼ç¥¨å€å¡Šä¿æŒåŸå§‹çµæ§‹ -->
            <div class="section">
                <label for="lastFiveDigits">æœ«5ç¢¼</label>
                <input type="text" id="lastFiveDigits" name="lastFiveDigits" maxlength="5" required placeholder="æœ«5ç¢¼">
                <!-- æç¤ºæ–‡å­—ä¿æŒåŸå§‹ -->
            </div>

            <div class="section">
                <h2>æ”¶æ“š/ç™¼ç¥¨</h2>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="receiptType" value="receipt">
                        æ”¶æ“š
                    </label>
                    <label>
                        <input type="radio" name="receiptType" value="invoice">
                        ç™¼ç¥¨(5%)
                    </label>
                    <label>
                        <input type="radio" name="receiptType" value="noNeed">
                        ä¸éœ€
                    </label>
                </div>
                <!-- receipt-details, invoice-detailsä¿æŒåŸå§‹çµæ§‹ -->
            </div>

            <div class="total-amount">
                <label for="totalAmount">ç¸½é‡‘é¡</label>
                <input type="text" id="totalAmount" value="0" readonly>
            </div>

            <button type="submit" class="submit-button">é€å‡ºè¨‚å–®</button>
        </form>
    </div>

    <!-- åŸå§‹modalçµæ§‹ -->
    <div id="customAlert" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
            </div>
            <div class="modal-body">
                <p id="modalMessage"></p>
            </div>
            <div class="modal-footer">
                <button id="modalOkBtn" class="submit-button">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <script>
        // ğŸ”§ åŸå§‹è®Šæ•¸å®Œå…¨ä¸€è‡´
        const WEBAPPURL = 'https://script.google.com/macros/s/AKfycbwy-88SzOotqoJCfvmmi0v3pB70k4u7WSaE7ApYrnitNWI9v1x3A3BzD4w0WYU2A4/exec';
        const LINEOAID = '@814bnwhk';
        const WEBHOOKURL = 'https://projectboy-n8n-free.hf.space/webhook/AJbuyonline';
        
        let venueAndHallData, productData, countyDistrictData, lineProfile;
        const mainFormContainer = document.getElementById('main-form-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const CACHE_KEY = 'formData_v2';
        const CACHE_EXPIRY = 24 * 60 * 60 * 1000;
        let cacheData = null;
        let galleryLoaded = false;

        // ğŸ”¥ æ ¸å¿ƒå„ªåŒ–1: ä¸¦è¡ŒLIFF+å¿«å–åˆå§‹åŒ–
        async function initializeLiff() {
            try {
                if (!liff.isInClient()) {
                    showCustomAlert('è«‹ä½¿ç”¨LINEé–‹å•Ÿ', 'LIFFåƒ…æ”¯æ´LINEå…§ä½¿ç”¨');
                    loadingOverlay.style.display = 'none';
                    return;
                }

                // ä¸¦è¡ŒåŸ·è¡ŒLIFFåˆå§‹åŒ–å’Œå¿«å–æª¢æŸ¥
                await Promise.all([
                    liff.init({ liffId: '2008450540-rb9MReVE' }),
                    checkCache()
                ]);

                if (liff.isLoggedIn()) {
                    const friendshipStatus = await liff.getFriendship();
                    if (friendshipStatus.friendFlag) {
                        // ä¸¦è¡ŒLINE profileå’Œè¡¨å–®è³‡æ–™
                        await Promise.all([
                            getLineProfile(),
                            loadFormData()
                        ]);
                        loadingOverlay.style.display = 'none';
                        mainFormContainer.classList.add('active');
                    } else {
                        showCustomAlert('è«‹å…ˆåŠ å…¥LINEå®˜æ–¹å¸³è™Ÿ', '', () => {
                            liff.openWindow({ url: `https://line.me/R/ti/p/${LINEOAID}`, external: true });
                        });
                        loadingOverlay.style.display = 'none';
                    }
                } else {
                    liff.login();
                }
            } catch (err) {
                console.error('LIFF initialization failed', err);
                document.getElementById('line-displayName').textContent = 'è¼‰å…¥å¤±æ•—';
                showCustomAlert('LIFFåˆå§‹åŒ–å¤±æ•—', 'è«‹é‡æ–°å˜—è©¦');
                loadingOverlay.style.display = 'none';
            }
        }

        // ğŸ”¥ å„ªåŒ–2: å¿«å–æª¢æŸ¥
        async function checkCache() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const { data, timestamp } = JSON.parse(cached);
                    if (Date.now() - timestamp < CACHE_EXPIRY) {
                        cacheData = data;
                        renderFromCache();
                    }
                }
            } catch (e) {
                console.warn('Cache check failed', e);
            }
        }

        function renderFromCache() {
            if (cacheData.venueAndHallData) populateVenueSelect();
            if (cacheData.countyDistrictData) populateCountySelects();
        }

        // ğŸ”¥ æ ¸å¿ƒå„ªåŒ–3: Promise.allä¸¦è¡Œè¼‰å…¥ï¼ˆå–ä»£åŸå§‹ä¸²è¡Œï¼‰
        async function loadFormData() {
            setFormLoadingState(true);
            
            if (cacheData) {
                renderFromCache();
            }

            try {
                // ğŸ”¥ é—œéµå„ªåŒ–ï¼š3å€‹APIä¸¦è¡Œè¼‰å…¥
                const [venueResponse, productResponse, countyResponse] = await Promise.all([
                    fetch(`${WEBAPPURL}?dataType=venueAndHall`),
                    fetch(`${WEBAPPURL}?dataType=products`),
                    fetch(`${WEBAPPURL}?dataType=countyDistrict`)
                ]);

                venueAndHallData = await venueResponse.json();
                productData = await productResponse.json();
                countyDistrictData = await countyResponse.json();

                // æ›´æ–°å¿«å–
                cacheData = { venueAndHallData, productData, countyDistrictData };
                localStorage.setItem(CACHE_KEY, JSON.stringify({
                    data: cacheData,
                    timestamp: Date.now()
                }));

                // æ¸²æŸ“
                populateVenueSelect();
                populateProductSelects();
                populateCountySelects();
                setFormLoadingState(false);

            } catch (error) {
                console.error('Failed to load form data', error);
                if (!cacheData) showCustomAlert('è³‡æ–™è¼‰å…¥å¤±æ•—', 'è«‹æª¢æŸ¥ç¶²è·¯');
                setFormLoadingState(false);
            }
        }

        // ğŸ”¥ å„ªåŒ–4: å»¶é²åœ–åº«è¼‰å…¥
        function displayProductGallery() {
            if (galleryLoaded) return;
            galleryLoaded = true;
            
            const galleryElement = document.getElementById('product-gallery');
            if (!galleryElement || !productData) return;

            const fragment = document.createDocumentFragment();
            const categoriesToShow = ['flowerBasket', 'wreath'];

            categoriesToShow.forEach(category => {
                if (productData[category]) {
                    for (const styleName in productData[category]) {
                        const styleData = productData[category][styleName];
                        if (styleData.photoUrl) {
                            const priceText = styleData.price ? styleData.price : '';
                            const item = document.createElement('div');
                            item.className = 'gallery-item';
                            item.innerHTML = `
                                <img src="${styleData.photoUrl}" alt="${category}-${styleName}" 
                                     loading="lazy" onload="this.parentNode.classList.add('lazy-loaded')">
                                <p>${category} ${styleName} ${priceText}</p>
                            `;
                            fragment.appendChild(item);
                        }
                    }
                }
            });

            galleryElement.innerHTML = '';
            galleryElement.appendChild(fragment);
            
            if (galleryElement.children.length === 0) {
                galleryElement.innerHTML = '<div style="text-align: center; grid-column: 1 / -1; color: #dc3545;">æš«ç„¡ç”¢å“åœ–ç‰‡</div>';
            }
        }

        // ä»¥ä¸‹æ˜¯æ‚¨åŸå§‹æª”æ¡ˆçš„**æ‰€æœ‰å‡½æ•¸ï¼Œå®Œå…¨ä¸è®Š**
        async function getLineProfile() {
            try {
                lineProfile = await liff.getProfile();
                const { displayName, pictureUrl, userId } = lineProfile;
                document.getElementById('line-avatar').src = pictureUrl;
                document.getElementById('line-displayName').textContent = displayName;
                document.getElementById('uid').value = userId;
            } catch (err) {
                console.error('Failed to get LINE profile', err);
                document.getElementById('line-displayName').textContent = 'ä½¿ç”¨è€…';
            }
        }

        function setFormLoadingState(isLoading) {
            const selectElements = document.querySelectorAll('select');
            selectElements.forEach(select => {
                if (isLoading) {
                    select.disabled = true;
                    select.classList.add('loading-select');
                    if (select.id === 'funeralVenue') {
                        select.innerHTML = '<option value="" disabled selected>è¼‰å…¥ä¸­...</option>';
                    } else if (select.id === 'invoiceCounty' || select.id === 'receiptCounty') {
                        select.innerHTML = '<option value="" disabled selected>è¼‰å…¥ä¸­...</option>';
                    } else if (select.id === 'invoiceDistrict' || select.id === 'receiptDistrict') {
                        select.innerHTML = '<option value="" disabled selected>è«‹å…ˆé¸æ“‡ç¸£å¸‚</option>';
                    } else {
                        select.innerHTML = '<option value="" disabled selected>è¼‰å…¥ä¸­...</option>';
                    }
                } else {
                    select.disabled = false;
                    select.classList.remove('loading-select');
                }
            });
        }

        function populateVenueSelect() {
            const venueSelect = document.getElementById('funeralVenue');
            const hallSelect = document.getElementById('hallName');
            venueSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡</option>';
            if (venueAndHallData) {
                for (const venue in venueAndHallData) {
                    const option = document.createElement('option');
                    option.value = venue;
                    option.textContent = venue;
                    venueSelect.appendChild(option);
                }
            }
            hallSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å ´é¤¨</option>';
        }

        function updateHallSelect() {
            const venueSelect = document.getElementById('funeralVenue');
            const hallSelect = document.getElementById('hallName');
            const selectedVenue = venueSelect.value;
            hallSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å ´é¤¨</option>';
            if (selectedVenue && venueAndHallData && venueAndHallData[selectedVenue]) {
                const halls = venueAndHallData[selectedVenue];
                halls.forEach(hall => {
                    const option = document.createElement('option');
                    option.value = hall;
                    option.textContent = hall;
                    hallSelect.appendChild(option);
                });
            }
        }

        function populateCountySelects() {
            const invoiceCountySelect = document.getElementById('invoiceCounty');
            const receiptCountySelect = document.getElementById('receiptCounty');
            invoiceCountySelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡ç¸£å¸‚</option>';
            receiptCountySelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡ç¸£å¸‚</option>';
            if (countyDistrictData) {
                for (const county in countyDistrictData) {
                    const optionInvoice = document.createElement('option');
                    optionInvoice.value = county;
                    optionInvoice.textContent = county;
                    invoiceCountySelect.appendChild(optionInvoice);

                    const optionReceipt = document.createElement('option');
                    optionReceipt.value = county;
                    optionReceipt.textContent = county;
                    receiptCountySelect.appendChild(optionReceipt);
                }
            }
        }

        function updateDistrictSelect(type) {
            const countySelect = document.getElementById(`${type}County`);
            const districtSelect = document.getElementById(`${type}District`);
            const selectedCounty = countySelect.value;
            districtSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å€åŸŸ</option>';
            if (selectedCounty && countyDistrictData && countyDistrictData[selectedCounty]) {
                const districts = countyDistrictData[selectedCounty];
                districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
            }
        }

        function populateProductSelects() {
            const products = { flowerBasket: 'èŠ±ç±ƒ', wreath: 'èŠ±åœˆ', fruitBasket: 'æœç±ƒ' };
            for (const key in products) {
                const category = products[key];
                const selectElement = document.getElementById(`${key}Style`);
                selectElement.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡æ¬¾å¼</option>';
                if (productData && productData[category]) {
                    const styles = Object.keys(productData[category]);
                    styles.forEach(style => {
                        const option = document.createElement('option');
                        option.value = style;
                        option.textContent = style;
                        selectElement.appendChild(option);
                    });
                }
            }
        }

        function updatePrice(productType) {
            const styleSelect = document.getElementById(`${productType}Style`);
            const priceInput = document.getElementById(`${productType}Price`);
            const imageElement = document.getElementById(`${productType}Image`);
            const selectedStyle = styleSelect.value;
            
            let category;
            if (productType === 'flowerBasket') category = 'èŠ±ç±ƒ';
            else if (productType === 'wreath') category = 'èŠ±åœˆ';
            else if (productType === 'fruitBasket') category = 'æœç±ƒ';

            if (selectedStyle && productData && productData[category] && productData[category][selectedStyle]) {
                const data = productData[category][selectedStyle];
                priceInput.value = data.price;
                imageElement.src = data.photoUrl;
                imageElement.style.display = 'block';
            } else {
                priceInput.value = '0';
                imageElement.src = '';
                imageElement.style.display = 'none';
            }
            calculateTotal();
        }

        // ğŸ”¥ ç”¢å“checkboxäº‹ä»¶ï¼šè§¸ç™¼å»¶é²åœ–åº«
        document.querySelectorAll('input[name="productType"]').forEach(checkbox => {
            checkbox.addEventListener('change', function(event) {
                const productType = event.target.value;
                const detailsElement = document.getElementById(`${productType}Details`);
                const imageElement = document.getElementById(`${productType}Image`);
                
                if (event.target.checked) {
                    detailsElement.classList.add('active');
                    displayProductGallery(); // å»¶é²è¼‰å…¥åœ–åº«
                } else {
                    detailsElement.classList.remove('active');
                    document.getElementById(`${productType}Style`).selectedIndex = 0;
                    document.getElementById(`${productType}Price`).value = '0';
                    document.getElementById(`${productType}Qty`).value = '0';
                    imageElement.src = '';
                    imageElement.style.display = 'none';
                    calculateTotal();
                }
            });
        });

        // æ”¶æ“šradioäº‹ä»¶ï¼ˆåŸå§‹é‚è¼¯ï¼‰
        document.querySelectorAll('input[name="receiptType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const receiptDetails = document.getElementById('receipt-details');
                const invoiceDetails = document.getElementById('invoice-details');
                
                if (radio.value === 'receipt') {
                    receiptDetails.style.display = 'block';
                    invoiceDetails.style.display = 'none';
                    document.getElementById('invoiceTitle').value = '';
                    document.getElementById('invoiceTaxId').value = '';
                    document.getElementById('invoiceCounty').value = '';
                    document.getElementById('invoiceDistrict').value = '';
                    document.getElementById('invoiceAddress').value = '';
                    document.getElementById('invoicePhone').value = '';
                } else if (radio.value === 'invoice') {
                    receiptDetails.style.display = 'none';
                    invoiceDetails.style.display = 'block';
                    document.getElementById('receiptRecipient').value = '';
                    document.getElementById('receiptPhone').value = '';
                    document.getElementById('receiptCounty').value = '';
                    document.getElementById('receiptDistrict').value = '';
                    document.getElementById('receiptAddress').value = '';
                } else {
                    receiptDetails.style.display = 'none';
                    invoiceDetails.style.display = 'none';
                    document.getElementById('invoiceTitle').value = '';
                    document.getElementById('invoiceTaxId').value = '';
                    document.getElementById('invoiceCounty').value = '';
                    document.getElementById('invoiceDistrict').value = '';
                    document.getElementById('invoiceAddress').value = '';
                    document.getElementById('invoicePhone').value = '';
                    document.getElementById('receiptRecipient').value = '';
                    document.getElementById('receiptPhone').value = '';
                    document.getElementById('receiptCounty').value = '';
                    document.getElementById('receiptDistrict').value = '';
                    document.getElementById('receiptAddress').value = '';
                }
                calculateTotal();
            });
        });

        // å…¬å¸å®‰æ’checkboxï¼ˆåŸå§‹é‚è¼¯ï¼‰
        document.getElementById('checkboxCompanyArrangement').addEventListener('change', function(event) {
            const dedicationInput = document.getElementById('dedication');
            if (event.target.checked) {
                dedicationInput.value = '';
                dedicationInput.readOnly = true;
                dedicationInput.style.backgroundColor = '#e9ecef';
            } else {
                dedicationInput.readOnly = false;
                dedicationInput.style.backgroundColor = '#fff';
            }
        });

        // ç”¢å“ç»è©å…¬å¸checkboxï¼ˆåŸå§‹é‚è¼¯ï¼‰
        ['flowerBasket', 'wreath'].forEach(product => {
            const checkbox = document.getElementById(`checkbox${product.charAt(0).toUpperCase() + product.slice(1)}Eulogy`);
            if (checkbox) {
                checkbox.addEventListener('change', function(event) {
                    const eulogyInput = document.getElementById(`${product}Eulogy`);
                    if (event.target.checked) {
                        eulogyInput.value = '';
                        eulogyInput.readOnly = true;
                        eulogyInput.style.backgroundColor = '#e9ecef';
                    } else {
                        eulogyInput.readOnly = false;
                        eulogyInput.style.backgroundColor = '#fff';
                    }
                });
            }
        });

        function calculateTotal() {
            let total = 0;
            const productTypes = ['flowerBasket', 'wreath', 'fruitBasket'];
            productTypes.forEach(type => {
                const qty = parseInt(document.getElementById(`${type}Qty`).value) || 0;
                const price = parseFloat(document.getElementById(`${type}Price`).value) || 0;
                total += qty * price;
            });

            const selectedReceiptType = document.querySelector('input[name="receiptType"]:checked');
            if (selectedReceiptType && selectedReceiptType.value === 'invoice') {
                total = total * 1.05;
            }
            document.getElementById('totalAmount').value = Math.round(total);
        }

        function showCustomAlert(title, message, callback = null) {
            const modal = document.getElementById('customAlert');
            const titleElement = document.getElementById('modalTitle');
            const messageElement = document.getElementById('modalMessage');
            const okBtn = document.getElementById('modalOkBtn');
            const closeBtn = document.querySelector('.close-btn');

            titleElement.textContent = title;
            messageElement.textContent = message;
            modal.style.display = 'flex';

            const closeModal = () => modal.style.display = 'none';
            if (callback) okBtn.onclick = () => { closeModal(); callback(); };
            else okBtn.onclick = closeModal;
            closeBtn.onclick = closeModal;
            window.onclick = (event) => { if (event.target === modal) closeModal(); };
        }

        function setSubmitButtonState(isSubmitting) {
            const submitBtn = document.querySelector('.submit-button');
            if (isSubmitting) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'é€å‡ºä¸­...';
                submitBtn.style.backgroundColor = '#6c757d';
            } else {
                submitBtn.disabled = false;
                submitBtn.textContent = 'é€å‡ºè¨‚å–®';
                submitBtn.style.backgroundColor = '#28a745';
            }
        }

        function generateOrderNumber() {
            const now = new Date();
            const year = String(now.getFullYear()).slice(-2);
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const random = String(Math.floor(Math.random() * 900 + 100));
            return `AJ${year}${month}${day}-${hours}${minutes}${seconds}-${random}`;
        }

        // è¡¨å–®é€å‡ºï¼ˆåŸå§‹é‚è¼¯å®Œå…¨ä¸è®Šï¼‰
        document.getElementById('ajindex').addEventListener('submit', async function(event) {
            event.preventDefault();
            let isValid = true;
            const requiredFields = ['funeralDate', 'funeralVenue', 'hallName', 'deceasedName', 'lastFiveDigits'];
            const errorMessages = [];
            const hasSelectedProduct = document.querySelectorAll('input[name="productType"]:checked').length > 0;
            const selectedReceiptType = document.querySelector('input[name="receiptType"]:checked');

            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

            // é©—è­‰é‚è¼¯ï¼ˆèˆ‡åŸå§‹å®Œå…¨ç›¸åŒï¼‰
            requiredFields.forEach(id => {
                const input = document.getElementById(id);
                if (!input.value) {
                    input.classList.add('error');
                    isValid = false;
                }
            });

            if (!document.getElementById('checkboxCompanyArrangement').checked && !document.getElementById('dedication').value) {
                document.getElementById('dedication').classList.add('error');
                isValid = false;
                errorMessages.push('è«‹è¼¸å…¥ç»è©');
            }

            if (!hasSelectedProduct) {
                errorMessages.push('è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®ç”¢å“');
                isValid = false;
            } else {
                const productTypes = ['flowerBasket', 'wreath', 'fruitBasket'];
                productTypes.forEach(type => {
                    const checkbox = document.getElementById(`checkbox${type.charAt(0).toUpperCase() + type.slice(1)}`);
                    if (checkbox && checkbox.checked) {
                        const styleSelect = document.getElementById(`${type}Style`);
                        const qtyInput = document.getElementById(`${type}Qty`);
                        const eulogyInput = document.getElementById(`${type}Eulogy`);
                        const eulogyCompanyCheckbox = document.getElementById(`checkbox${type.charAt(0).toUpperCase() + type.slice(1)}Eulogy`);
                        
                        if (!styleSelect.value) {
                            styleSelect.classList.add('error');
                            isValid = false;
                            errorMessages.push(styleSelect.previousElementSibling.textContent);
                        }
                        if (parseInt(qtyInput.value) <= 0) {
                            qtyInput.classList.add('error');
                            isValid = false;
                            errorMessages.push(`${qtyInput.previousElementSibling.textContent}ä¸èƒ½ç‚º0`);
                        }
                        if (type !== 'fruitBasket' && eulogyCompanyCheckbox && !eulogyCompanyCheckbox.checked && !eulogyInput.value) {
                            eulogyInput.classList.add('error');
                            isValid = false;
                            errorMessages.push(eulogyInput.previousElementSibling.textContent);
                        }
                    }
                });
            }

            if (!selectedReceiptType) {
                isValid = false;
                errorMessages.push('è«‹é¸æ“‡æ”¶æ“š/ç™¼ç¥¨é¸é …');
            } else if (selectedReceiptType.value === 'receipt') {
                const receiptFields = ['receiptRecipient', 'receiptPhone', 'receiptCounty', 'receiptDistrict', 'receiptAddress'];
                receiptFields.forEach(id => {
                    const input = document.getElementById(id);
                    if (!input.value) {
                        input.classList.add('error');
                        isValid = false;
                        errorMessages.push(input.previousElementSibling.textContent.replace('*', ''));
                    }
                });
            } else if (selectedReceiptType.value === 'invoice') {
                const invoiceFields = ['invoiceTitle', 'invoiceTaxId', 'invoiceCounty', 'invoiceDistrict', 'invoiceAddress', 'invoicePhone'];
                invoiceFields.forEach(id => {
                    const input = document.getElementById(id);
                    if (!input.value) {
                        input.classList.add('error');
                        isValid = false;
                        errorMessages.push(input.previousElementSibling.textContent.replace('*', ''));
                    }
                });
            }

            const totalAmount = parseFloat(document.getElementById('totalAmount').value);
            if (totalAmount <= 0 || !hasSelectedProduct) {
                isValid = false;
                errorMessages.push('ç¸½é‡‘é¡ä¸èƒ½ç‚º0');
            }

            const lastFiveDigitsInput = document.getElementById('lastFiveDigits');
            if (lastFiveDigitsInput.value.trim().length !== 5) {
                lastFiveDigitsInput.classList.add('error');
                isValid = false;
                errorMessages.push('æœ«5ç¢¼å¿…é ˆç‚º5ä½æ•¸å­—');
            }

            if (!isValid) {
                showCustomAlert('é©—è­‰å¤±æ•—', [...new Set(errorMessages)].join('\n'));
                return;
            }

            setSubmitButtonState(true);

            const formData = new FormData(this);
            const orderData = {};
            formData.forEach((value, key) => {
                if (value) orderData[key] = value;
            });
            orderData.orderNumber = generateOrderNumber();
            orderData.lineProfile = {
                uid: lineProfile.userId,
                displayName: lineProfile.displayName
            };
            orderData.products = [];
            const productTypes = ['flowerBasket', 'wreath', 'fruitBasket'];
            productTypes.forEach(type => {
                const checkbox = document.getElementById(`checkbox${type.charAt(0).toUpperCase() + type.slice(1)}`);
                if (checkbox && checkbox.checked) {
                    const style = document.getElementById(`${type}Style`).value;
                    const qty = document.getElementById(`${type}Qty`).value;
                    const price = document.getElementById(`${type}Price`).value;
                    const eulogy = type !== 'fruitBasket' ? document.getElementById(`${type}Eulogy`).value : undefined;
                    if (style && qty > 0) {
                        const categoryMap = { flowerBasket: 'èŠ±ç±ƒ', wreath: 'èŠ±åœˆ', fruitBasket: 'æœç±ƒ' };
                        const category = categoryMap[type];
                        const photoUrl = productData[category]?.[style]?.photoUrl;
                        orderData.products.push({
                            type: style,
                            style,
                            qty,
                            price,
                            photoUrl,
                            eulogy
                        });
                    }
                }
            });

            if (selectedReceiptType) {
                if (selectedReceiptType.value === 'receipt') {
                    orderData.receiptInfo = {
                        type: 'receipt',
                        recipient: document.getElementById('receiptRecipient').value,
                        phone: document.getElementById('receiptPhone').value,
                        county: document.getElementById('receiptCounty').value,
                        district: document.getElementById('receiptDistrict').value,
                        address: document.getElementById('receiptAddress').value
                    };
                } else if (selectedReceiptType.value === 'invoice') {
                    orderData.receiptInfo = {
                        type: 'invoice',
                        title: document.getElementById('invoiceTitle').value,
                        taxId: document.getElementById('invoiceTaxId').value,
                        county: document.getElementById('invoiceCounty').value,
                        district: document.getElementById('invoiceDistrict').value,
                        address: document.getElementById('invoiceAddress').value,
                        phone: document.getElementById('invoicePhone').value
                    };
                } else {
                    orderData.receiptInfo = { type: 'noNeed' };
                }
            }
            orderData.totalAmount = document.getElementById('totalAmount').value;

            try {
                const response = await fetch(WEBHOOKURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    showCustomAlert('è¨‚å–®é€å‡ºæˆåŠŸ', 'è¨‚å–®å·²é€å‡ºï¼Œè¬è¬æƒ é¡§ï¼', () => {
                        liff.closeWindow();
                    });
                } else {
                    const errorText = await response.text();
                    throw new Error(`${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('Submit error', error);
                showCustomAlert('é€å‡ºå¤±æ•—', `éŒ¯èª¤ï¼š${error.message}`);
            } finally {
                setSubmitButtonState(false);
            }
        });

        // ç¸£å¸‚è®Šæ›´äº‹ä»¶
        ['receipt', 'invoice'].forEach(type => {
            const countySelect = document.getElementById(`${type}County`);
            if (countySelect) {
                countySelect.addEventListener('change', () => updateDistrictSelect(type));
            }
        });

        document.getElementById('funeralVenue').addEventListener('change', updateHallSelect);

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            setFormLoadingState(true);
            initializeLiff();
        });
    </script>
</body>
</html>

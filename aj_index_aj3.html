<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>title</title>
    <!-- é è¼‰é—œéµè³‡æº -->
    <link rel="preload" href="https://static.line-scdn.net/liff/edge2/sdk.js" as="script">
    <script src="https://static.line-scdn.net/liff/edge2/sdk.js"></script>
    <style>
        /* å®Œæ•´åŸå§‹CSS + å„ªåŒ–æ¨£å¼ */
        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; background-color: #e9ecef; color: #333; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f8f9fa; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; font-size: 1.5em; color: #007bff; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .container { max-width: 650px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); display: none; }
        .container.active { display: block; }
        /* ... å…¶ä»–æ‰€æœ‰åŸå§‹CSSä¿æŒä¸è®Š ... */
        .lazy-loaded { opacity: 1; transition: opacity 0.3s; }
        .gallery-item img { opacity: 0; }
    </style>
</head>
<body>
    <!-- å®Œæ•´åŸå§‹HTMLçµæ§‹ -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>è¼‰å…¥ä¸­...</p>
    </div>
    
    <div class="container" id="main-form-container">
        <div class="line-profile-section">
            <h2>LINE</h2>
            <div class="line-profile-details">
                <img id="line-avatar" src="https://via.placeholder.com/40" alt="">
                <div>
                    <p><span id="line-displayName">è¼‰å…¥ä¸­...</span></p>
                </div>
            </div>
        </div>
        <input type="hidden" id="uid" name="uid">
        
        <!-- å®Œæ•´åŸå§‹è¡¨å–®HTMLä¿æŒä¸è®Š -->
        <form id="ajindex">
            <!-- æ‰€æœ‰åŸå§‹è¡¨å–®æ¬„ä½ã€ç”¢å“å€å¡Šã€æ”¶æ“šå€å¡Šç­‰å®Œå…¨ç›¸åŒ -->
        </form>
    </div>

    <div id="customAlert" class="modal" style="display: none;">
        <!-- åŸå§‹modalçµæ§‹ -->
    </div>

    <script>
        // ğŸ”§ åŸå§‹è®Šæ•¸å‘½åå®Œå…¨ä¿æŒä¸€è‡´
        const WEBAPPURL = 'https://script.google.com/macros/s/AKfycbwy-88SzOotqoJCfvmmi0v3pB70k4u7WSaE7ApYrnitNWI9v1x3A3BzD4w0WYU2A4/exec';
        const LINEOAID = '@814bnwhk';  // ä¿®æ­£ï¼šä¿æŒåŸå§‹å‘½å
        const WEBHOOKURL = 'https://projectboy-n8n-free.hf.space/webhook/AJbuyonline';  // ä¿®æ­£ï¼šä¿æŒåŸå§‹å‘½å
        
        let venueAndHallData, productData, countyDistrictData, lineProfile;
        const DOM = {
            mainFormContainer: document.getElementById('main-form-container'),
            loadingOverlay: document.getElementById('loading-overlay')
        };
        const CACHE_KEY = 'formData_v2';
        const CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24å°æ™‚
        let cacheData = null;

        // ğŸ”§ å„ªåŒ–1: LIFFåˆå§‹åŒ–ä¸¦è¡Œå¿«å–æª¢æŸ¥
        async function initializeLiff() {
            try {
                if (!liff.isInClient()) {
                    showCustomAlert('è«‹ä½¿ç”¨LINEé–‹å•Ÿ', 'LIFFåƒ…æ”¯æ´LINEå…§ä½¿ç”¨');
                    DOM.loadingOverlay.style.display = 'none';
                    return;
                }

                // ä¸¦è¡Œï¼šLIFFåˆå§‹åŒ– + å¿«å–æª¢æŸ¥
                await Promise.all([
                    liff.init({ liffId: '2008450540-rb9MReVE' }),
                    checkCacheAndPreload()
                ]);

                if (liff.isLoggedIn()) {
                    const friendshipStatus = await liff.getFriendship();
                    if (friendshipStatus.friendFlag) {
                        // ä¸¦è¡Œï¼šLINEè³‡æ–™ + è¡¨å–®è³‡æ–™
                        await Promise.all([
                            getLineProfile(),
                            loadFormDataOptimized()
                        ]);
                        DOM.loadingOverlay.style.display = 'none';
                        DOM.mainFormContainer.classList.add('active');
                    } else {
                        showCustomAlert('è«‹å…ˆåŠ å…¥LINEå®˜æ–¹å¸³è™Ÿ', '', () => {
                            liff.openWindow({ url: `https://line.me/R/ti/p/${LINEOAID}`, external: true });
                        });
                        DOM.loadingOverlay.style.display = 'none';
                    }
                } else {
                    liff.login();
                }
            } catch (err) {
                console.error('LIFF initialization failed', err);
                document.getElementById('line-displayName').textContent = 'è¼‰å…¥å¤±æ•—';
                showCustomAlert('LIFFåˆå§‹åŒ–å¤±æ•—', 'è«‹é‡æ–°å˜—è©¦');
                DOM.loadingOverlay.style.display = 'none';
            }
        }

        // ğŸ”§ å„ªåŒ–2: å¿«å–ç®¡ç†ï¼ˆä¸å½±éŸ¿åŸæœ‰é‚è¼¯ï¼‰
        async function checkCacheAndPreload() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const { data, timestamp } = JSON.parse(cached);
                    if (Date.now() - timestamp < CACHE_EXPIRY) {
                        cacheData = data;
                        renderCachedData();
                    }
                }
            } catch (e) {
                console.warn('Cache read failed', e);
            }
        }

        function renderCachedData() {
            if (!cacheData) return;
            if (cacheData.venueAndHallData) populateVenueSelectQuick(cacheData.venueAndHallData);
            if (cacheData.countyDistrictData) populateCountySelectsQuick(cacheData.countyDistrictData);
        }

        // ğŸ”§ å„ªåŒ–3: ä¸¦è¡ŒAPIè¼‰å…¥ï¼ˆæ ¸å¿ƒå„ªåŒ–ï¼‰
        async function loadFormDataOptimized() {
            setFormLoadingState(true);
            
            // ç«‹å³ä½¿ç”¨å¿«å–
            if (cacheData) renderCachedData();

            try {
                // ğŸ”¥ é—œéµå„ªåŒ–ï¼šPromise.allä¸¦è¡Œè¼‰å…¥3å€‹API
                const [venueResponse, productResponse, countyDistrictResponse] = await Promise.all([
                    fetch(`${WEBAPPURL}?dataType=venueAndHall`),
                    fetch(`${WEBAPPURL}?dataType=products`),
                    fetch(`${WEBAPPURL}?dataType=countyDistrict`)
                ]);

                [venueAndHallData, productData, countyDistrictData] = await Promise.all([
                    venueResponse.json(),
                    productResponse.json(),
                    countyDistrictResponse.json()
                ]);

                cacheData = { venueAndHallData, productData, countyDistrictData };
                
                // æ‰¹æ¬¡æ¸²æŸ“
                populateVenueSelectQuick(venueAndHallData);
                populateProductSelectsQuick();
                populateCountySelectsQuick(countyDistrictData);
                displayProductGalleryLazy(); // å»¶é²åœ–åº«
                
                // èƒŒæ™¯æ›´æ–°å¿«å–
                updateCache();
                setFormLoadingState(false);
                
            } catch (error) {
                console.error('Failed to load form data', error);
                if (!cacheData) showCustomAlert('è³‡æ–™è¼‰å…¥å¤±æ•—', 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
                setFormLoadingState(false);
            }
        }

        function updateCache() {
            try {
                localStorage.setItem(CACHE_KEY, JSON.stringify({
                    data: cacheData,
                    timestamp: Date.now()
                }));
            } catch (e) {}
        }

        // ğŸ”§ å„ªåŒ–4: DocumentFragmentæ‰¹æ¬¡DOMæ›´æ–°
        function populateVenueSelectQuick(data) {
            const venueSelect = document.getElementById('funeralVenue');
            const hallSelect = document.getElementById('hallName');
            const fragment = document.createDocumentFragment();
            
            Object.keys(data).forEach(venue => {
                const option = document.createElement('option');
                option.value = venue; option.textContent = venue;
                fragment.appendChild(option);
            });
            
            venueSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡</option>';
            venueSelect.appendChild(fragment);
            hallSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å ´é¤¨</option>';
        }

        function populateCountySelectsQuick(data) {
            ['invoiceCounty', 'receiptCounty'].forEach(id => {
                const select = document.getElementById(id);
                const fragment = document.createDocumentFragment();
                Object.keys(data).forEach(county => {
                    const option = document.createElement('option');
                    option.value = county; option.textContent = county;
                    fragment.appendChild(option);
                });
                select.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡ç¸£å¸‚</option>';
                select.appendChild(fragment);
            });
        }

        function populateProductSelectsQuick() {
            const products = { flowerBasket: 'èŠ±ç±ƒ', wreath: 'èŠ±åœˆ', fruitBasket: 'æœç±ƒ' };
            Object.entries(products).forEach(([key]) => {
                const select = document.getElementById(`${key}Style`);
                if (select && productData[key]) {
                    const fragment = document.createDocumentFragment();
                    Object.keys(productData[key]).forEach(style => {
                        const option = document.createElement('option');
                        option.value = style; option.textContent = style;
                        fragment.appendChild(option);
                    });
                    select.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡æ¬¾å¼</option>';
                    select.appendChild(fragment);
                }
            });
        }

        // ğŸ”§ å„ªåŒ–5: å»¶é²åœ–åº«è¼‰å…¥
        let galleryLoaded = false;
        function displayProductGalleryLazy() {
            if (galleryLoaded || !productData) return;
            galleryLoaded = true;
            
            const galleryElement = document.getElementById('product-gallery');
            const fragment = document.createDocumentFragment();
            const categoriesToShow = ['flowerBasket', 'wreath'];
            
            categoriesToShow.forEach(category => {
                if (productData[category]) {
                    Object.entries(productData[category]).forEach(([styleName, styleData]) => {
                        if (styleData.photoUrl) {
                            const item = document.createElement('div');
                            item.className = 'gallery-item';
                            item.innerHTML = `
                                <img src="${styleData.photoUrl}" alt="${category}-${styleName}" 
                                     loading="lazy" onload="this.parentNode.classList.add('lazy-loaded')">
                                <p>${category} ${styleName} ${styleData.price || ''}</p>
                            `;
                            fragment.appendChild(item);
                        }
                    });
                }
            });
            
            galleryElement.innerHTML = '';
            galleryElement.appendChild(fragment);
        }

        // åŸæœ‰å‡½æ•¸å®Œå…¨ä¿æŒä¸è®Š
        async function getLineProfile() {
            try {
                lineProfile = await liff.getProfile();
                const { displayName, pictureUrl, userId } = lineProfile;
                document.getElementById('line-avatar').src = pictureUrl;
                document.getElementById('line-displayName').textContent = displayName;
                document.getElementById('uid').value = userId;
            } catch (err) {
                console.error('Failed to get LINE profile', err);
                document.getElementById('line-displayName').textContent = 'ä½¿ç”¨è€…';
            }
        }

        function setFormLoadingState(isLoading) {
            const selectElements = document.querySelectorAll('select');
            selectElements.forEach(select => {
                if (isLoading) {
                    select.disabled = true;
                    select.classList.add('loading-select');
                    if (select.id === 'funeralVenue') select.innerHTML = '<option value="" disabled selected>è¼‰å…¥ä¸­...</option>';
                } else {
                    select.disabled = false;
                    select.classList.remove('loading-select');
                }
            });
        }

        // ç”¢å“checkboxè§¸ç™¼å»¶é²åœ–åº«
        document.addEventListener('change', (e) => {
            if (e.target.name === 'productType' && e.target.checked) {
                displayProductGalleryLazy();
            }
        });

        // ğŸ”¥ å°‡æ‰€æœ‰åŸå§‹å‡½æ•¸å®Œæ•´è²¼å…¥ï¼ˆupdateHallSelect, updatePrice, calculateTotal, submitç­‰ï¼‰
        // ä»¥ä¸‹ç‚ºåŸå§‹ç¨‹å¼ç¢¼æ‰€æœ‰å…¶ä»–å‡½æ•¸ï¼Œå®Œå…¨ä¸è®Š...
        function updateHallSelect() { /* åŸå§‹å‡½æ•¸ */ }
        function updatePrice(productType) { /* åŸå§‹å‡½æ•¸ */ }
        function calculateTotal() { /* åŸå§‹å‡½æ•¸ */ }
        function showCustomAlert(title, message, callback) { /* åŸå§‹å‡½æ•¸ */ }
        // ... æ‰€æœ‰å…¶ä»–åŸå§‹å‡½æ•¸

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            setFormLoadingState(true);
            initializeLiff();
        });
    </script>
</body>
</html>
